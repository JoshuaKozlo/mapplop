function stateClicked(t){if(activeState.node()===this&&null===activeCity.node())return reset();activeCity.classed("activeCity",!1),activeCity=d3.select(null),activeState.classed("activeState",!1),activeState=d3.select(this).classed("activeState",!0);var e=path.bounds(t),a=e[1][0]-e[0][0],i=e[1][1]-e[0][1],n=(e[0][0]+e[1][0])/2,s=(e[0][1]+e[1][1])/2,r=.9/Math.max(a/width,i/height),c=[width/2-r*n,height/2-r*s];g.transition().duration(1500).style("stroke-width",.1/r+"px").attr("transform","translate("+c+")scale("+r+")"),headlineState.innerHTML=t.properties.name,getVenues("state",t),cg.selectAll(".place-label").style("font-size",1.5/r+"rem")}function cityClicked(t){activeCity.node()!==this&&(activeCity.classed("activeCity",!1),activeCity=d3.select(this).classed("activeCity",!0),headlineState.innerHTML=t.properties.name+", "+t.properties.state,getVenues("city",t))}function reset(){activeCity.classed("activeCity",!1),activeCity=d3.select(null),activeState.classed("activeState",!1),activeState=d3.select(null),g.transition().duration(1500).style("stroke-width",".07px").attr("transform",""),headlineState.innerHTML="United States",getVenues("US"),cg.selectAll(".place-label").style("font-size","1rem")}function resize(){width=parseInt(d3.select(".map").style("width")),width=width-margin.left-margin.right,height=width*mapRatio,projection.translate([width/2,height/2]).scale(width),path.pointRadius(function(t){return t.properties.venue_count*projection.scale()*3e-4}),svg.style("width",width+"px").style("height",height+"px"),svg.select("rect").attr("width",width).attr("height",height),g.selectAll(".state").attr("d",path),g.selectAll(".city").attr("d",path),g.selectAll(".place-label").attr("transform",function(t){return"translate("+projection(t.geometry.coordinates)+")"}),reset()}function layoutUS(t){var e,a;for($(".data").empty(),i=0;i<t.length;i++)t[i].city_state[1]===e&&t[i].city_state[0]===a?$("."+row).append(venueDiv(t[i])):(a=t[i].city_state[0],e=t[i].city_state[1],row="row-"+i,$(".data").append("<h1 class='city-state col-xs-12'>- "+t[i].city_state[0]+", "+t[i].city_state[1]+" -</h1>"),$(".data").append("<div class='row "+row+"'></div>"),$("."+row).append(venueDiv(t[i])));$(".venue:only-child").addClass("col-lg-offset-4")}function getVenues(t,e){var a;a="US"===t?{scale:"US"}:"state"===t?{scale:"state",state:e.id}:{scale:"city",state:e.properties.state,city:e.properties.name},$.getJSON("/getVenues/",a).done(function(t){layoutUS(t)})}function venueDiv(t){var e=t.street+" "+t.city_state[0]+" "+t.city_state[1],a="https://www.google.com/maps/place/"+e.split(" ").join("+"),i='<div class="venue col-lg-4 col-md-6 col-xs-12 col-centered"><h1>'+t.name+'</h1><a target="_blank" href="http://www.'+t.website+'"><img class="center-block" src="'+t.image+'"></a><a target="_blank" href="'+a+'"><h2 class="street">-'+t.street+"-</h2></a></div>";return i}var headlineState=document.getElementById("nav-headline"),isMobile={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return isMobile.Android()||isMobile.BlackBerry()||isMobile.iOS()||isMobile.Opera()||isMobile.Windows()}},margin={top:10,left:10,bottom:10,right:10},width=parseInt(d3.select(".map").style("width"));width=width-margin.left-margin.right,mapRatio=.46,height=width*mapRatio,activeState=d3.select(null),activeCity=d3.select(null);var projection=d3.geo.albersUsa().scale(width).translate([width/2,height/2]),path=d3.geo.path().projection(projection).pointRadius(function(t){return t.properties.venue_count*projection.scale()*3e-4+.4}),svg=d3.select(".map").append("svg").attr("width",width).attr("height",height);svg.append("rect").attr("class","background").attr("width",width).attr("height",height).on("click",reset);var g=svg.append("g").style("stroke-width",".07px"),sg=g.append("g"),cg=g.append("g");d3.json("https://s3.amazonaws.com/mapplopstaticmedia/static/json/USA.json",function(t){sg.selectAll(".state").data(topojson.feature(t,t.objects.ne_10m_USA_states).features).enter().append("path").attr("d",path).attr("class",function(t){return"state "+t.id}).on("click",stateClicked)}),null==isMobile.any()&&d3.json("/getCities/",function(t){cg.selectAll(".city").data(t.features).enter().append("path").attr("d",path).attr("class",function(t){return"city "+t.properties.name}).attr("fill","#C54B51").on("click",cityClicked).append("title").text(function(t){return t.properties.name}),cg.selectAll(".place-label").data(t.features).enter().append("text").style("font-size","1rem").attr("class","place-label").attr("transform",function(t){return"translate("+projection(t.geometry.coordinates)+")"}).attr("dx",".1rem").text(function(t){return t.properties.population>5e5?t.properties.name:void 0})}),d3.select(window).on("resize",resize),$(document).ready(function(){getVenues("US")});